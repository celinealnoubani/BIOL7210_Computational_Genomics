# GeMoMa Gene Prediction & EggNOG Annotation Results

This repository contains the results of a two-step gene analysis pipeline executed on the PACE cluster. First, genes are predicted using the GeMoMa pipeline, and then the predicted protein sequences are annotated using EggNOG-mapper. This repository includes input data, GeMoMa output files, EggNOG result TSVs, log files, the main commands script, and the overall data file structure.

## System Specifications

- **Cluster Environment**: PACE Cluster  
- **Modules**: Anaconda 3 (2023.03)
- **Quality of Service**: coc-ice
- **Node Type**: AMD CPU  
  - **Processor Model**: AMD EPYC 7513 32-Core Processor  
  - **Allocated Cores**: 16  
- **Memory**: 32 GB

## Tools Used

- **GeMoMa**: Version 1.9  
- **EggNOG-mapper**: Version 2.1.12

## Language Used

- **GNU Bash**: Version 5.0.18
- **Python**: Version 3.10.13 for gemoma_env & 3.8.20 for eggnog_env

## Important Notes

- The provided pipeline scripts assume that the file structure of this repository matches the layout on the PACE cluster. Adjust file paths if files are relocated.
- Performance metrics (runtime, memory usage, and CPU utilization) for both GeMoMa and EggNOG-mapper are recorded in log files.
- For large datasets, consider removing the `--dbmem` parameter in EggNOG-mapper to prevent memory issues, as annotation requires substantial RAM.
- Some results and logs may be compressed (e.g., using gzip) for easier storage and transfer.
- Final annotation files are now available in GFF format with the naming convention `{sample_name}_GeMoMa_EggNOG.gff`.

## File Structure

- **`data/`**  
  - **`contigs/`**:  
    Contains filtered contig FASTA files for each sample.
  - **`reference/`**:  
    Contains reference genome files used by GeMoMa (genomic FASTA and GFF files).

- **`results/`**  
  - **`gemoma/`**:  
    Contains output folders for each sample from the GeMoMa pipeline. Each folder includes:  
    - `predicted_proteins.fasta`: Predicted protein sequences in FASTA format.  
    - `[sample]_GeMoMa.gff`: GFF annotation file with predicted gene models.  
    - `[sample]_predicted_proteins_clean.faa`: Cleaned protein sequences (asterisks removed).
    - Other intermediate files generated by GeMoMa.
  - **`eggnog/`**:  
    Contains EggNOG-mapper output folders for each sample. Each folder includes:
    - `[sample].emapper.annotations.tsv`: Tab-separated annotation results.
    - `[sample].emapper.hits`: Diamond search results showing ortholog matches.
    - `[sample].emapper.decorated.gff`: GFF file with EggNOG annotations integrated into GeMoMa predictions.
    - Other intermediate files generated by EggNOG-mapper.
  - **`final_annotations/`**:  
    Contains the final GFF and optionally GenBank format files with standardized naming:
    - `[sample]_GeMoMa.gff`: Original GeMoMa gene predictions.
    - `[sample]_GeMoMa_EggNOG.gff`: Combined structural and functional annotations.
    - `[sample]_GeMoMa_EggNOG.gbk`: GenBank format of the annotated genome (if conversion tool is available).

- **`logs/`**:  
  Contains log files for each sample documenting runtime, memory usage, and CPU utilization for both GeMoMa and EggNOG-mapper:
  - `[sample]_gemoma_time.log`: Performance metrics for GeMoMa.
  - `[sample]_eggnog_time.log`: Performance metrics for EggNOG-mapper.

- **`final_report/`**:  
  Contains a consolidated TSV file (`final_metrics.tsv`) that summarizes performance metrics and output statistics for both tools:  
  - For GeMoMa, the TSV row includes the sample name, tool ("GeMoMa"), memory usage, runtime, CPU usage, CDS count, and "NA" for annotated proteins.  
  - For EggNOG, the TSV row includes the sample name, tool ("EggNOG"), memory usage, runtime, CPU usage, "NA" for CDS count, and the number of annotated proteins.

- **`scratch/`**:  
  - **`eggnog_db/`**:  
    Contains the EggNOG database files required for annotation:(On PACE not on GitHub)
    - `eggnog.db`: Main annotation database.
    - `eggnog_proteins.dmnd`: Diamond sequence database.
    - `eggnog.taxa.db`: Taxonomy database.
    - Other supporting database files.

- **`scripts/`**:
  - `run_pipeline.sh`: Contains the commands used to run the GeMoMa and EggNOG workflows (main pipeline script).
  - `gemoma_env.yml`: GeMoMa enviroment set up file.
  - `eggnog_env.yml`: EggNOG enviroment set up file.

- **`README.md`**:  
  This file, which describes the project, system specifications, tools used, and file structure.

## Pipeline Overview

1. **GeMoMa**: Uses reference-based gene prediction to identify coding sequences in bacterial genomes.
   - Input: Contig FASTA files for each sample
   - Output: Predicted gene models (GFF) and protein sequences (FASTA)
   - Parameters: 4 CPU threads, ReAlign scoring

2. **EggNOG-mapper**: Provides functional annotation of predicted proteins using orthologous groups.
   - Input: Predicted protein sequences from GeMoMa
   - Output: Functional annotations including GO terms, protein families, and orthologs
   - Parameters: 8 CPU threads, bacterial taxonomic scope, all GO evidence types
   - Enhanced Output: Decorated GFF files using the `--decorate_gff` parameter to integrate functional annotations with structural predictions

## Final Output Files

The pipeline now produces standardized annotation files in the `final_annotations` directory:

- `[sample]_GeMoMa.gff`: Original structural annotations from GeMoMa.
- `[sample]_GeMoMa_EggNOG.gff`: Complete annotations with both structural (GeMoMa) and functional (EggNOG) information.
- `[sample]_GeMoMa_EggNOG.gbk`: (Optional) GenBank format file if the conversion tool is available in the environment.

These files follow the naming convention `{sample_name}_{prediction_tool}_{annotation_tool}.{extension}` as recommended for standardized genomic analyses.

## Setup and Requirements

To recreate the conda environments used in this project:

```bash
# For GeMoMa environment
conda create -f gemoma_env.yml -y

# For EggNOG environment
conda create -n eggnog_env python=3.8 -y
conda activate eggnog_env
conda install -c conda-forge -c bioconda eggnog-mapper=2.1.12 -y
download_eggnog_data.py --data_dir /path/to/eggnog_db
```

Alternatively:
```bash
conda create -f eggnog_env.yml -y
```

## Running the Pipeline

To run the complete pipeline:
```bash
bash run_pipeline.sh
```

The script will process all contig files in the `data/contigs/` directory, perform gene prediction with GeMoMa, and then annotate the predicted proteins with EggNOG-mapper. Performance metrics and final annotation files will be generated automatically.
